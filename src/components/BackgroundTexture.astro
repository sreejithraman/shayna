---
// BackgroundTexture.astro
// Provides grain texture and color wash for the dark atmospheric aesthetic
---

<div class="fixed inset-0 pointer-events-none z-0" id="bg-texture" aria-hidden="true">
  <!-- Grain layer (3% opacity per moodboard) -->
  <div class="absolute inset-0 opacity-[0.03]" id="grain"></div>

  <!-- Color wash - subtle violet radial gradient -->
  <div
    class="absolute inset-0"
    style="background: radial-gradient(ellipse 80% 60% at 50% 30%, rgba(139, 92, 246, 0.04) 0%, transparent 70%);"
    id="wash"
  ></div>
</div>

<script>
  // Generate SVG noise pattern for grain texture
  function createGrainSVG(): string {
    const svg = `
      <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">
        <filter id="noise">
          <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/>
        </filter>
        <rect width="100%" height="100%" filter="url(#noise)"/>
      </svg>
    `;
    return `data:image/svg+xml;base64,${btoa(svg.trim())}`;
  }

  // Apply grain texture
  const grain = document.getElementById('grain');
  if (grain) {
    grain.style.backgroundImage = `url("${createGrainSVG()}")`;
    grain.style.backgroundRepeat = 'repeat';
  }

  // Subtle parallax effect for wash layer (responds to cursor)
  const wash = document.getElementById('wash');
  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  if (wash && !prefersReducedMotion) {
    const maxMovement = 0.3; // 0.3x movement ratio

    document.addEventListener('mousemove', (e) => {
      const x = (e.clientX / window.innerWidth - 0.5) * 2; // -1 to 1
      const y = (e.clientY / window.innerHeight - 0.5) * 2; // -1 to 1

      const translateX = x * maxMovement * 20; // max 6px
      const translateY = y * maxMovement * 20; // max 6px

      wash.style.transform = `translate(${translateX}px, ${translateY}px)`;
    });

    // Mobile gyroscope support
    if ('DeviceOrientationEvent' in window) {
      window.addEventListener('deviceorientation', (e) => {
        if (e.gamma === null || e.beta === null) return;

        const x = Math.max(-45, Math.min(45, e.gamma)) / 45; // -1 to 1
        const y = Math.max(-45, Math.min(45, e.beta - 45)) / 45; // -1 to 1

        const translateX = x * maxMovement * 20;
        const translateY = y * maxMovement * 20;

        wash.style.transform = `translate(${translateX}px, ${translateY}px)`;
      });
    }
  }
</script>

<style>
  #bg-texture {
    /* GPU acceleration for smooth transforms */
    will-change: transform;
  }

  #wash {
    transition: transform 0.15s ease-out;
  }

  @media (prefers-reduced-motion: reduce) {
    #wash {
      transition: none;
    }
  }
</style>
